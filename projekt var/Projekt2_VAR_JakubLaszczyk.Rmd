 ---
title: "Model VAR"
author: "Jakub Laszczyk"
date: "2025-05-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Cel Projektu
Celem projektu jest zbudowanie modelu VAR, mając na celu analizę przyczynowości Grangera i uzyskanie informacji potencjalnego wzajemnego wpływu rynków.


## Przygotowanie danych
### Biblioteki
```{r}
library(dplyr)
library(lubridate)
library(zoo)
library(tseries)
library(vars)
library(ggplot2)
library(vars)              
```


### Wczytanie danych
```{r}
# Wczytanie danych 
Oil <- read.csv("Brent-Oil.csv", sep = ",", header = TRUE)
Wig <- read.csv("wig.csv", sep = ",", header = TRUE)
Dax <- read.csv("dax.csv", sep = ",", header = TRUE)
Bel <- read.csv("bel.csv", sep = ",", header = TRUE)
EurUsd <- read.csv("eurusd.csv", sep = ",", header = TRUE)
PlnUsd <- read.csv("plnusd.csv", sep = ",", header = TRUE)
```

### Wybór odpowiednich kolumn
```{r}
# Wybieranie odpowiednich kolumn 
Oil <- Oil[, c(1:2)]
Wig <- Wig[, c(1,5)]
Dax <- Dax[, c(1,5)]
Bel <- Bel[, c(1,5)]
EurUsd <- EurUsd[, c(1,5)]
PlnUsd <- PlnUsd[, c(1,5)]
```

### Zmiana nazw kolumn
```{r}
names(Oil) <- c("Date", "Oil")
names(Wig) <- c("Date", "Wig")
names(Dax) <- c("Date", "Dax")
names(Bel) <- c("Date", "Bel")
names(EurUsd) <- c("Date", "EurUsd")
names(PlnUsd) <- c("Date", "PlnUsd")
```

### Utworzenie ramki danych
```{r}
library(lubridate)
#Tworzenie ramki danych 
Data <- data.frame(seq(as.Date("2010-01-01"), to = as.Date("2022-11-29"), by = "day"))
names(Data) = c("Date")
Data$Dzien <- wday(Data$Date, week_start=1)
Data <- Data[!(Data$Dzien ==6 | Data$Dzien == 7), 1]
Data <- data.frame(Data)
names(Data) <- c("Date")

# Wczytywanie danych 
Oil$Date <- mdy(Oil$Date)
Wig$Date <- ymd(Wig$Date)
Bel$Date <- ymd(Bel$Date)
Dax$Date <- ymd(Dax$Date)
EurUsd$Date <- ymd(EurUsd$Date)
PlnUsd$Date <- ymd(PlnUsd$Date)
library(dplyr)
# Łaczenie wszytskich ramek danych w jedna
df <- Data |> left_join(Wig, by="Date")
df <- df %>% left_join(Bel, by="Date")
df <- df %>% left_join(Dax, by="Date")
df <- df %>% left_join(Oil, by="Date")
df <- df %>% left_join(EurUsd, by="Date")
df <- df %>% left_join(PlnUsd, by="Date")

rr = list()

for (i in 1:nrow(df)){
  if(sum(is.na(df[i,])) >= 4){
    rr <- append(rr, i)
  }
}
rr <- unlist(rr)
df <- df[-rr,]
data <- df[, 1:5]
head(data)
```

**Uwaga:** Wszelkie obliczenia są realizowane z wykorzystaniem programu R, a przyjęty poziom istotności wynosi α = 5%. 

### Uzupełnienie braków danych 

Metoda interpolacji liniowej - funkcja na.approx() 

```{r} 
for (i in 2:ncol(df)) 
{ 
  df[,i] <- na.approx(df[,i], na.rm = FALSE)
}
```


### Przewalutowanie do $

```{r}
df <- df %>% dplyr::mutate(Wig = Wig * PlnUsd, Dax = Dax * EurUsd, Bel = Bel * EurUsd)
df <- df %>% dplyr::select("Date", "Wig", "Dax", "Bel", "Oil")
```

Fragment gotowego zbioru danych: 
```{r, fig.align="center", echo=FALSE}
knitr::kable(head(df), align = "lcccr")
```

### Indeksy dzienne

```{r, echo = FALSE}
p <- ggplot(data = df) + 
  geom_line(aes(x = Date, y = Wig, color = "Wig")) + 
  geom_line(aes(x = Date, y = Dax, color = "Dax")) + 
  geom_line(aes(x = Date, y = Bel, color = "Bel")) + 
  geom_line(aes(x = Date, y = Oil, color = "Oil")) + 
  scale_fill_discrete(name = "Indeks") + 
  ggtitle("Wykres indeks") +
  xlab("Date") + ylab("Usd")
p
```


## Logarytmiczne stopy zwrotu 

W kolejnym kroku dane zostały przekształcone według wzoru: $R_l = \ln(\frac{P_t}{p_{t-1}})$

gdzie:  

 * $R_l$ - logarytmiczna stopa zwrotu,  
 * $P_t$ - wartość zamknięcia indeksu w czasie t,  
 * $P_{t−1}$ - wartość zamknięcia indeksu w czasie t-1,    

Otrzymujemy logarytmiczne stopy zwrotu


```{r}
stopy_zwrotu <- as.data.frame(matrix(0, nrow(df)-1, 5))

stopy_zwrotu[,1] = df$Date[-1]

for(i in 1:nrow(df)-1)
{ 
  stopy_zwrotu[i,2]=log(df[i+1,2] / df[i,2])
  stopy_zwrotu[i,3]=log(df[i+1,3] / df[i,3])
  stopy_zwrotu[i,4]=log(df[i+1,4] / df[i,4])
  stopy_zwrotu[i,5]=log(df[i+1,5] / df[i,5])
}
```

```{r, fig.align="center", echo=FALSE}
colnames(stopy_zwrotu) <- colnames(df)[]
knitr::kable(head(stopy_zwrotu), align = "lcccr")
```

Wykres

```{r, echo=FALSE}
p <- ggplot(data = stopy_zwrotu) + 
  geom_line(aes(x = Date, y = Wig, color = "Wig")) + 
  geom_line(aes(x = Date, y = Dax, color = "Dax")) + 
  geom_line(aes(x = Date, y = Bel, color = "Bel")) + 
  geom_line(aes(x = Date, y = Oil, color = "Oil")) + 
  scale_fill_discrete(name = "Indeks") + 
  ggtitle("Wykres logarytmicznych stóp zwrotu") +
  xlab("Date") + ylab("Usd")

p
```

## Test stacjonarności

Dickey’a-Fuller adf.test()

 *H0 : szereg jest niestacjonarny*   
 *H1 : szereg jest stacjonarny.*
 
```{r, warning=FALSE}
adf_resut <- as.data.frame(matrix(0, 1, 4))

adf_resut[1,1] <- adf.test(stopy_zwrotu[,2],alternative = c("stationary"))$p.value
adf_resut[1,2] <- adf.test(stopy_zwrotu[,3],alternative = c("stationary"))$p.value
adf_resut[1,3] <- adf.test(stopy_zwrotu[,4],alternative = c("stationary"))$p.value 
adf_resut[1,4] <- adf.test(stopy_zwrotu[,5],alternative = c("stationary"))$p.value
``` 
```{r}
names(adf_resut) <- c("Wig", "Dax", "Bel", "Oil")
stopy_zwrotu <- stopy_zwrotu[,-1]
adf_resut
```
Szeregi stóp zwrotu są stacjonarne, ponieważ żadna wartość nie przekracza 0,05

## Model VAR

### Rząd opóźnień

```{r}
var <- VARselect(stopy_zwrotu)$selection
```

```{r, fig.align="center", echo=FALSE}
var_res <- as.data.frame(matrix(var, 1, 4))
names(var_res) <- c("AIC", "HQ", "SC", "FPE")
var_res
```
Kryteria HQ oraz SC wskazują na wybór modelu z 1 opóźnieniem, natomiast AIC i FPE z 8 opóźnieniami, jednakże wartości kryterium FPE są w przybliżeniu równe zero, a zatem ostatecznie analizując pierwsze 3 kryteria zostaje wybrany model VAR rzędu p=1.

### Model VAR z opóźnieniem rzędu p=1 

```{r}
model <- VAR(stopy_zwrotu, p=1)
summary(model)
```

Korelacje reszt modelu
Korelacje dodatnie, szczególnie silne:

DAX i BEL (0.91) – podobne rynki, silna korelacja

WIG i DAX (0.69), WIG i BEL (0.68) – potwierdzają silne związki między rynkami

- na polską giełdę (WIG) w istotny sposób wpływają jedynie stopy zwrotu
  dla Polski z opóźnieniem 1 oraz stopy zwrotu niemieckiej giełdy(DAX),
- na niemiecką giełdę w istotny sposób wpływa jedynie cena ropy naftowej,
- na belgijską giełdę(Bel) w istotny sposób nie wpływa, żadna ze zmiennych,
- na cenę ropy naftowej(Oil) w istotny sposób wpływają stopy zwrotu giełd polskiej, niemieckiej oraz belgi-
jskiej.


## Weryfikacja modelu

### Istotność zmiennych (t-studenta)

```{r}

coef_var <- as.data.frame(matrix(0, 5, 4))
names(coef_var) <- c("Wig", "Dax", "Bel", "Oil")

s <- summary(model)

coef_var[,1] <- s$varresult$Wig$coefficients[,4]
coef_var[,2] <- s$varresult$Dax$coefficients[,4]
coef_var[,3] <- s$varresult$Bel$coefficients[,4]
coef_var[,4] <- s$varresult$Oil$coefficients[,4]

coef_var
```
(Indeks poniżej 0,05 -> ma wpływ)
 Wig.l1
Istotny wpływ na Wig (p = 0.0074) – ujemny, jak wcześniej zauważyliśmy.

Nieistotny wpływ na pozostałe, ale bliski istotności dla Oil (p = 0.0440)

 Dax.l1
Istotny wpływ na Wig (p = 0.0041) – pozytywny wpływ.

Istotny wpływ na Oil (p = 0.0043) – ujemny wpływ.

Brak istotności w pozostałych przypadkach.

 Bel.l1
Silnie istotny wpływ na Oil (p < 0.001) – pozytywny.

W pozostałych przypadkach nieistotny.

4⃣Oil.l1
Istotny wpływ na Dax (p = 0.0075) – pozytywny.

Granicznie istotny wpływ na Bel (p = 0.0647)

Brak wpływu na siebie i Wig.


### Łączna istotność zmiennych (test F)

```{r, fig.align="center"}
F_test <- as.data.frame(matrix(0, 1, 4))
names(F_test) <- c("Wig", "Dax", "Bel", "Oil")

F_test[,1] <- pf(s$varresult$Wig$fstatistic[1], s$varresult$Wig$fstatistic[2], s$varresult$Wig$fstatistic[3], lower.tail = FALSE)
F_test[,2] <- pf(s$varresult$Dax$fstatistic[1], s$varresult$Dax$fstatistic[2], s$varresult$Dax$fstatistic[3], lower.tail = FALSE)
F_test[,3] <- pf(s$varresult$Bel$fstatistic[1], s$varresult$Bel$fstatistic[2], s$varresult$Bel$fstatistic[3], lower.tail = FALSE)
F_test[,4] <- pf(s$varresult$Oil$fstatistic[1], s$varresult$Oil$fstatistic[2], s$varresult$Oil$fstatistic[3], lower.tail = FALSE)

F_test
```
W modelu, w którym y to DAX, zmienne x nie miały istotnego wpływu. Pozostałe modele wykazują łączną istotność zmiennych (odrzucenie H₀.

### Autokorelacja (test Ljunga-Boxa)

*H0 :* $∀_j : ρ_j = 0$ − brak autokorelacji składnika losowego do rzędu p włącznie
*H1 :* $∃_j : ρ_j ̸= 0$ − istnieje przynajmniej jedna autokorelacja różna od zera

```{r}
Box_test <- as.data.frame(matrix(0, 1, 4))
names(Box_test) <- c("Wig", "Dax", "Bel", "Oil")

Box_test[,1] <- Box.test(model$varresult$Wig$residuals, lag = 1, type = "Ljung-Box")$p.value
Box_test[,2] <- Box.test(model$varresult$Dax$residuals, lag = 1, type = "Ljung-Box")$p.value
Box_test[,3] <- Box.test(model$varresult$Bel$residuals, lag = 1, type = "Ljung-Box")$p.value
Box_test[,4] <- Box.test(model$varresult$Oil$residuals, lag = 1, type = "Ljung-Box")$p.value

Box_test
```
Brak podstaw do odrzucenia H0, brak autokorelacji w modelach.

### Normalność reszt ( Shapiro-Wilk)

*H0 : rozkład reszt jest normalny*   
*H1 : brak rozkładu normalnego reszt* 

```{r}
norm_test <- as.data.frame(matrix(0, 1, 4))
names(norm_test) <- c("Wig", "Dax", "Bel", "Oil")

norm_test[,1] <- shapiro.test(model$varresult$Wig$residuals)$p.value
norm_test[,2] <- shapiro.test(model$varresult$Dax$residuals)$p.value
norm_test[,3] <- shapiro.test(model$varresult$Bel$residuals)$p.value
norm_test[,4] <- shapiro.test(model$varresult$Oil$residuals)$p.value

norm_test
```
Wartość p-value mniejsza od 5% pozwala na odrzucenie hipotezy zerowej, jednakże powołując się na Centralne Twierdzenie Graniczne został przyjęty asymptotyczny rozkład normalny.

## Przyczynowość w sensie Grangera

*H0 : zmienna X nie jest przyczyną w sensie Grangera zmiennej Y*    
*H1 : zmienna X jest przyczyną w sensie Grangera zmiennej Y*  

```{r}
grang_test <- as.data.frame(matrix(0, 1, 4))
names(grang_test) <- c("Wig", "Dax", "Bel", "Oil")

shapiro.test(model$varresult$Wig$residuals)$p.value

grang_test[,1] <- causality(model, cause = c("Wig"))$Granger$p.value
grang_test[,2] <- causality(model, cause = c("Dax"))$Granger$p.value
grang_test[,3] <- causality(model, cause = c("Bel"))$Granger$p.value
grang_test[,4] <- causality(model, cause = c("Oil"))$Granger$p.value

grang_test
```
Jedynie dla WIG można stwierdzić, że nie zachodzi przyczynowość Grangera(wartość powyżej 0,05)

- giełda niemiecka9Dax) jest przyczyną w sensie Grangera względem pozostałych giełd i ceny ropy,
- giełda belgijska(Bel) jest przyczyną w sensie Grangera względem pozostałych giełd i ceny ropy,   
- cena ropy naftowej(Oil) jest przyczyną w sensie Grangera względem pozostałych giełd. 

#test reakcji na impuls 
```{r}
plot_irf <- function(model, impulse, response_vars) {
  irf_result <- irf(model,
                    impulse = impulse,
                    response = response_vars,
                    n.ahead = 10,
                    ortho = TRUE,
                    runs = 100)
  plot(irf_result, main = paste("Reakcja na impuls -", toupper(impulse)))
}

# Lista zmiennych (impulsy i reakcje)
zmienne <- c("Wig", "Dax", "Bel", "Oil")

# Pętla: dla każdego impulsu rysuj reakcję pozostałych zmiennych
for (impuls in zmienne) {
  plot_irf(model, impulse = impuls, response_vars = zmienne)
}

```

